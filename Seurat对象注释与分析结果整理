ğŸ§¬ å•ç»†èƒRNAæµ‹åºæ•°æ®é‡æ–°æ³¨é‡Šé¡¹ç›®
ğŸ“Š é¡¹ç›®æ¦‚è¿°
é¡¹ç›®åç§°: å•ç»†èƒRNAæµ‹åºæ•°æ®ç»†èƒç±»å‹é‡æ–°æ³¨é‡Š
å¤„ç†æ—¶é—´: 2025-07-08 09:53:17 UTC
ç”¨æˆ·: buyu-ahau
æ•°æ®è§„æ¨¡: 35,330ä¸ªç»†èƒï¼Œ33,029ä¸ªåŸºå› ï¼Œ20ä¸ªclusters

An object of class Seurat 
33029 features across 35330 samples within 1 assay 
Active assay: RNA (33029 features, 0 variable features)
 2 layers present: counts, data
 11 dimensional reductions calculated: pca, pca_RNA, harmony_RNA, tsne, tsne_harmony_RNA, umap, umap_harmony_RNA, tsne3, tsne3_harmony_RNA, umap3, umap3_harmony_RNA
                        orig.ident nCount_RNA nFeature_RNA Groups percent.mito
Day0_1_AAACCCACATAGGCGA     Day0_1      10481         3022   Day0    4.3125656
Day0_1_AAACCCATCCGGGACT     Day0_1       4734         1970   Day0    2.0278834
Day0_1_AAACCCATCGCAATTG     Day0_1       7007         2900   Day0    2.7972028
Day0_1_AAACGAAAGCTCGACC     Day0_1        843          679   Day0    0.4744958
Day0_1_AAACGAAAGGTTAAAC     Day0_1       7632         3029   Day0   15.5136268
Day0_1_AAACGAAAGTTGCCTA     Day0_1       7792         3323   Day0    2.7464066
                        percent.hgb group     S.Score   G2M.Score Phase
Day0_1_AAACCCACATAGGCGA  0.00000000  Day0 -0.24797287 -0.65619968    G1
Day0_1_AAACCCATCCGGGACT  0.00000000  Day0 -0.06457320 -0.28059581    G1
Day0_1_AAACCCATCGCAATTG  0.00000000  Day0 -0.12722984 -0.35322732    G1
Day0_1_AAACGAAAGCTCGACC  0.00000000  Day0  0.06270087  0.02365137     S
Day0_1_AAACGAAAGGTTAAAC  0.00000000  Day0  0.57675070  0.70242888   G2M
Day0_1_AAACGAAAGTTGCCTA  0.01283368  Day0 -0.36228807 -0.41465378    G1
                        CC.Difference RNA_snn_res.0.5 seurat_clusters
Day0_1_AAACCCACATAGGCGA    0.40822680               4               4
Day0_1_AAACCCATCCGGGACT    0.21602262               8               8
Day0_1_AAACCCATCGCAATTG    0.22599748               0               0
Day0_1_AAACGAAAGCTCGACC    0.03904950               7               7
Day0_1_AAACGAAAGGTTAAAC   -0.12567818               6               6
Day0_1_AAACGAAAGTTGCCTA    0.05236571              16              16
                               celltype   celltype_final
Day0_1_AAACCCACATAGGCGA      Macrophage      Macrophages
Day0_1_AAACCCATCCGGGACT       NK-T_cell        CD4_cells
Day0_1_AAACCCATCGCAATTG       NK-T_cell        CD8_cells
Day0_1_AAACGAAAGCTCGACC     Plasma_cell          B_cells
Day0_1_AAACGAAAGGTTAAAC       NK-T_cell        CD8_cells
Day0_1_AAACGAAAGTTGCCTA Epithelial_cell Epithelial_cells
 [1] "orig.ident"      "nCount_RNA"      "nFeature_RNA"    "Groups"         
 [5] "percent.mito"    "percent.hgb"     "group"           "S.Score"        
 [9] "G2M.Score"       "Phase"           "CC.Difference"   "RNA_snn_res.0.5"
[13] "seurat_clusters" "celltype"        "celltype_final" 

          B_cells         CD4_cells         CD8_cells          DC_cells 
             2226              1838              9450               832 
Endothelial_cells  Epithelial_cells       Fibroblasts       Macrophages 
              862               624              1131              6054 
      Neutrophils          NK_cells      Plasma_cells 
             3425               747              8141 
ğŸ”„ å…³é”®ä¿®æ­£è¯´æ˜
Cluster 18: ä» Unknown_cells â†’ Fibroblasts (88 cells)
Cluster 19: ä» Unknown_cells â†’ Serous_cells (66 cells)
ğŸ“ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
ä¸»è¦æ•°æ®æ–‡ä»¶:

object_final_annotated.qs - é‡æ–°æ³¨é‡Šåçš„å®Œæ•´Seuratå¯¹è±¡
celltype_summary_corrected.csv - ç»†èƒç±»å‹ç»Ÿè®¡æ‘˜è¦
cluster2celltype_map_corrected.csv - Clusteråˆ°ç»†èƒç±»å‹æ˜ å°„è¡¨


# å•ç»†èƒRNAæµ‹åºæ•°æ®é‡æ–°æ³¨é‡Šè„šæœ¬
# é¡¹ç›®: ç»†èƒç±»å‹é‡æ–°æ³¨é‡Š (æ‰€æœ‰ç»†èƒç±»å‹åä»¥å¤æ•°'s'ç»“å°¾)
# æ—¥æœŸ: 2025-07-08
# ç”¨æˆ·: buyu-ahau
# 
# åŠŸèƒ½æè¿°:
# 1. åŠ è½½å·²æœ‰çš„Seuratå¯¹è±¡
# 2. æ ¹æ®é¢„å®šä¹‰æ˜ å°„é‡æ–°æ³¨é‡Šç»†èƒç±»å‹
# 3. ä¿®æ­£cluster 18å’Œ19çš„æ³¨é‡Š
# 4. ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šå’Œæ˜ å°„è¡¨
# 5. ä¿å­˜æ³¨é‡Šåçš„å¯¹è±¡

library(qs)
library(Seurat)
library(dplyr)

# ============================================================================
# 1. æ•°æ®åŠ è½½å’ŒåŸºæœ¬ä¿¡æ¯æ£€æŸ¥
# ============================================================================

# åŠ è½½åŸå§‹æ•°æ®
file_path <- "/disk192/users_dir/buyu/2025-7-7é‡æ–°æ³¨é‡Šç»“æœ/object_annotated_gene_symbols.qs"
sc_object <- qread(file_path)

cat("=" %R% 50, "\n")
cat("å•ç»†èƒæ•°æ®é‡æ–°æ³¨é‡Šå¼€å§‹\n")
cat("=" %R% 50, "\n")

cat("å¯¹è±¡ä¿¡æ¯:\n")
print(sc_object)

# æ£€æŸ¥ç°æœ‰çš„clusterä¿¡æ¯
cat("\nç°æœ‰clusteråˆ†å¸ƒ:\n")
cluster_dist <- table(sc_object$seurat_clusters)
print(cluster_dist)

cat("\nClusterçš„å”¯ä¸€å€¼:", sort(unique(as.character(sc_object$seurat_clusters))), "\n")

# ============================================================================
# 2. å®šä¹‰ç»†èƒç±»å‹æ˜ å°„å…³ç³»
# ============================================================================

# å®šä¹‰å®Œæ•´çš„clusteråˆ°celltypeæ˜ å°„
# æ³¨æ„: cluster 18å’Œ19å·²æ ¹æ®ç”Ÿç‰©å­¦ç‰¹å¾é‡æ–°å®šä¹‰
final_map <- c(
  "0" = "CD8_cells",           # Tç»†èƒäºšç¾¤ - ç»†èƒæ¯’æ€§Tç»†èƒ
  "1" = "Plasma_cells",        # Bç»†èƒåˆ†åŒ–äº§ç‰© - æµ†ç»†èƒ
  "2" = "Plasma_cells",        # Bç»†èƒåˆ†åŒ–äº§ç‰© - æµ†ç»†èƒ
  "3" = "Neutrophils",         # å…ˆå¤©å…ç–«ç»†èƒ - ä¸­æ€§ç²’ç»†èƒ
  "4" = "Macrophages",         # å…ˆå¤©å…ç–«ç»†èƒ - å·¨å™¬ç»†èƒ
  "5" = "Macrophages",         # å…ˆå¤©å…ç–«ç»†èƒ - å·¨å™¬ç»†èƒ
  "6" = "CD8_cells",           # Tç»†èƒäºšç¾¤ - ç»†èƒæ¯’æ€§Tç»†èƒ
  "7" = "B_cells",             # é€‚åº”æ€§å…ç–«ç»†èƒ - Bç»†èƒ
  "8" = "CD4_cells",           # Tç»†èƒäºšç¾¤ - è¾…åŠ©æ€§Tç»†èƒ
  "9" = "Fibroblasts",         # åŸºè´¨ç»†èƒ - æˆçº¤ç»´ç»†èƒ
  "10" = "DC_cells",           # æŠ—åŸå‘ˆé€’ç»†èƒ - æ ‘çªçŠ¶ç»†èƒ
  "11" = "NK_cells",           # å…ˆå¤©å…ç–«ç»†èƒ - è‡ªç„¶æ€ä¼¤ç»†èƒ
  "12" = "Endothelial_cells",  # è¡€ç®¡ç»†èƒ - å†…çš®ç»†èƒ
  "13" = "Epithelial_cells",   # ä¸Šçš®ç»†èƒ
  "14" = "Endothelial_cells",  # è¡€ç®¡ç»†èƒ - å†…çš®ç»†èƒ
  "15" = "B_cells",            # é€‚åº”æ€§å…ç–«ç»†èƒ - Bç»†èƒ
  "16" = "Epithelial_cells",   # ä¸Šçš®ç»†èƒ
  "17" = "NK_cells",           # å…ˆå¤©å…ç–«ç»†èƒ - è‡ªç„¶æ€ä¼¤ç»†èƒ
  "18" = "Fibroblasts",        # ã€ä¿®æ­£ã€‘åŸºè´¨ç»†èƒ - æˆçº¤ç»´ç»†èƒ
  "19" = "Serous_cells"        # ã€ä¿®æ­£ã€‘åˆ†æ³Œç»†èƒ - æµ†æ¶²æ€§ç»†èƒ
)

cat("\nåº”ç”¨çš„æ˜ å°„å…³ç³»:\n")
cat("-" %R% 40, "\n")
for (i in 1:length(final_map)) {
  cat(sprintf("Cluster %2s -> %-18s\n", names(final_map)[i], final_map[i]))
}
cat("-" %R% 40, "\n")

# ============================================================================
# 3. éªŒè¯æ˜ å°„å®Œæ•´æ€§
# ============================================================================

# æ£€æŸ¥æ‰€æœ‰clusteræ˜¯å¦éƒ½æœ‰æ˜ å°„
all_clusters <- sort(unique(as.character(sc_object$seurat_clusters)))
mapped_clusters <- names(final_map)
missing_clusters <- setdiff(all_clusters, mapped_clusters)

cat("\næ˜ å°„éªŒè¯:\n")
cat("æ‰€æœ‰cluster:", paste(all_clusters, collapse = ", "), "\n")
cat("æ˜ å°„çš„cluster:", paste(mapped_clusters, collapse = ", "), "\n")

if (length(missing_clusters) > 0) {
  cat("âŒ è­¦å‘Š: ç¼ºå¤±çš„cluster:", paste(missing_clusters, collapse = ", "), "\n")
  stop("è¯·ä¸ºæ‰€æœ‰clusterå®šä¹‰æ˜ å°„")
} else {
  cat("âœ… æ‰€æœ‰clusteréƒ½æœ‰å¯¹åº”çš„æ˜ å°„\n")
}

# ============================================================================
# 4. æ‰§è¡Œé‡æ–°æ³¨é‡Š
# ============================================================================

cat("\næ­£åœ¨æ·»åŠ æ–°çš„ç»†èƒç±»å‹æ³¨é‡Š...\n")

# å°†clusterè½¬æ¢ä¸ºå­—ç¬¦å‹
cluster_char <- as.character(sc_object$seurat_clusters)

# åˆ›å»ºç»†èƒç±»å‹å‘é‡
celltype_vector <- final_map[cluster_char]

# æ£€æŸ¥æ˜ å°„ç»“æœ
cat("æ˜ å°„æ£€æŸ¥:\n")
cat("  æ€»ç»†èƒæ•°:", length(celltype_vector), "\n")
cat("  æˆåŠŸæ˜ å°„æ•°:", sum(!is.na(celltype_vector)), "\n")
cat("  NAæ•°é‡:", sum(is.na(celltype_vector)), "\n")

if (sum(is.na(celltype_vector)) > 0) {
  na_clusters <- unique(cluster_char[is.na(celltype_vector)])
  cat("âŒ å¯¼è‡´NAçš„cluster:", paste(na_clusters, collapse = ", "), "\n")
  stop("å­˜åœ¨æœªæ˜ å°„çš„cluster")
} else {
  cat("âœ… æ‰€æœ‰ç»†èƒéƒ½æˆåŠŸæ˜ å°„\n")
}

# ç›´æ¥æ·»åŠ åˆ°metadata
sc_object@meta.data$celltype_final <- celltype_vector

# ============================================================================
# 5. éªŒè¯å’Œç»Ÿè®¡åˆ†æ
# ============================================================================

if ("celltype_final" %in% colnames(sc_object@meta.data)) {
  cat("âœ… æˆåŠŸæ·»åŠ celltype_finalåˆ—\n")
  
  # è®¾ç½®æ–°çš„identity
  Idents(sc_object) <- "celltype_final"
  
  # ç»Ÿè®¡ç»†èƒç±»å‹åˆ†å¸ƒ
  cat("\n" %R% "=" %R% 50, "\n")
  cat("ç»†èƒç±»å‹åˆ†å¸ƒç»Ÿè®¡\n")
  cat("=" %R% 50, "\n")
  
  celltype_counts <- table(sc_object@meta.data$celltype_final)
  celltype_percent <- prop.table(celltype_counts) * 100
  
  summary_table <- data.frame(
    ç»†èƒç±»å‹ = names(celltype_counts),
    ç»†èƒæ•°é‡ = as.integer(celltype_counts),
    ç™¾åˆ†æ¯” = sprintf("%.2f%%", celltype_percent),
    stringsAsFactors = FALSE
  )
  
  # æŒ‰ç»†èƒæ•°é‡é™åºæ’åˆ—
  summary_table <- summary_table[order(summary_table$ç»†èƒæ•°é‡, decreasing = TRUE), ]
  
  # æ·»åŠ æ’å
  summary_table$æ’å <- 1:nrow(summary_table)
  summary_table <- summary_table[, c("æ’å", "ç»†èƒç±»å‹", "ç»†èƒæ•°é‡", "ç™¾åˆ†æ¯”")]
  
  print(summary_table)
  
  # clusteråˆ°celltypeæ˜ å°„è¡¨
  cat("\n" %R% "=" %R% 50, "\n")
  cat("Clusteråˆ°ç»†èƒç±»å‹æ˜ å°„è¡¨\n")
  cat("=" %R% 50, "\n")
  
  cluster_table <- data.frame(
    Cluster = sort(unique(as.integer(sc_object$seurat_clusters))),
    ç»†èƒç±»å‹ = final_map[as.character(sort(unique(sc_object$seurat_clusters)))],
    ç»†èƒæ•°é‡ = as.vector(table(sc_object$seurat_clusters)[as.character(sort(unique(sc_object$seurat_clusters)))]),
    stringsAsFactors = FALSE
  )
  print(cluster_table)
  
  # éªŒè¯æ¯ä¸ªclusterçš„æ˜ å°„
  cat("\néªŒè¯clusteræ˜ å°„:\n")
  cat("-" %R% 50, "\n")
  
  all_correct <- TRUE
  for (cluster in sort(unique(as.character(sc_object$seurat_clusters)))) {
    expected_celltype <- final_map[cluster]
    actual_celltypes <- unique(sc_object@meta.data$celltype_final[cluster_char == cluster])
    cluster_count <- sum(cluster_char == cluster)
    
    if (length(actual_celltypes) == 1 && actual_celltypes == expected_celltype) {
      status_icon <- if(cluster %in% c("18", "19")) "ğŸ”„" else "âœ…"
      cat(sprintf("%s Cluster %2s -> %-18s (%d cells)\n", 
                  status_icon, cluster, expected_celltype, cluster_count))
    } else {
      cat(sprintf("âŒ Cluster %s æ˜ å°„é”™è¯¯\n", cluster))
      all_correct <- FALSE
    }
  }
  
  if (all_correct) {
    cat("-" %R% 50, "\n")
    cat("âœ… æ‰€æœ‰clusteræ˜ å°„éªŒè¯é€šè¿‡\n")
  }

# ============================================================================
# 6. ä¿å­˜ç»“æœ
# ============================================================================

  cat("\n" %R% "=" %R% 50, "\n")
  cat("ä¿å­˜ç»“æœæ–‡ä»¶\n")
  cat("=" %R% 50, "\n")
  
  # ä¿å­˜æ›´æ–°åçš„Seuratå¯¹è±¡
  output_path <- "/disk192/users_dir/buyu/2025-7-7é‡æ–°æ³¨é‡Šç»“æœ/object_final_annotated.qs"
  qsave(sc_object, output_path)
  cat("âœ… ä¿å­˜Seuratå¯¹è±¡åˆ°:", output_path, "\n")
  
  # ä¿å­˜ç»Ÿè®¡è¡¨æ ¼
  write.csv(summary_table, file = "celltype_summary_corrected.csv", row.names = FALSE)
  write.csv(cluster_table, file = "cluster2celltype_map_corrected.csv", row.names = FALSE)
  cat("âœ… ä¿å­˜ç»Ÿè®¡è¡¨æ ¼åˆ°å½“å‰ç›®å½•\n")
  
  # ============================================================================
  # 7. ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
  # ============================================================================
  
  cat("\n" %R% "=" %R% 60, "\n")
  cat("æœ€ç»ˆæ³¨é‡ŠæŠ¥å‘Š\n")
  cat("=" %R% 60, "\n")
  
  cat("ğŸ“… å¤„ç†æ—¶é—´:", as.character(Sys.time()), "\n")
  cat("ğŸ‘¤ ç”¨æˆ·:", "buyu-ahau", "\n")
  cat("ğŸ”¢ æ€»ç»†èƒæ•°:", format(ncol(sc_object), big.mark = ","), "\n")
  cat("ğŸ§¬ æ€»åŸºå› æ•°:", format(nrow(sc_object), big.mark = ","), "\n")
  cat("ğŸ“Š Clusteræ•°:", length(unique(sc_object$seurat_clusters)), "\n")
  cat("ğŸ·ï¸  ç»†èƒç±»å‹æ•°:", length(unique(sc_object@meta.data$celltype_final)), "\n")
  cat("ğŸ¥‡ æœ€å¤§ç»†èƒç¾¤:", summary_table$ç»†èƒç±»å‹[1], 
      sprintf("(%s cells, %s)", 
              format(summary_table$ç»†èƒæ•°é‡[1], big.mark = ","),
              summary_table$ç™¾åˆ†æ¯”[1]), "\n")
  
  cat("\nğŸ”„ å…³é”®ä¿®æ­£:\n")
  cat("   â€¢ Cluster 18: 88 cells  -> Fibroblasts\n")
  cat("   â€¢ Cluster 19: 66 cells  -> Serous_cells\n")
  
  cat("\nğŸ“‚ ç”Ÿæˆæ–‡ä»¶:\n")
  cat("   â€¢ object_final_annotated.qs - å®Œæ•´çš„æ³¨é‡Šå¯¹è±¡\n")
  cat("   â€¢ celltype_summary_corrected.csv - ç»†èƒç±»å‹ç»Ÿè®¡\n")
  cat("   â€¢ cluster2celltype_map_corrected.csv - æ˜ å°„å…³ç³»è¡¨\n")
  
  cat("\n=" %R% 60, "\n")
  cat("âœ… é‡æ–°æ³¨é‡ŠæˆåŠŸå®Œæˆï¼\n")
  cat("=" %R% 60, "\n")
  
} else {
  cat("âŒ æ·»åŠ celltype_finalåˆ—å¤±è´¥\n")
}

cat("\nğŸ‰ è„šæœ¬æ‰§è¡Œå®Œæˆï¼\n")

# è‡ªå®šä¹‰å­—ç¬¦ä¸²é‡å¤å‡½æ•°
`%R%` <- function(x, n) {
  paste(rep(x, n), collapse = "")
}
