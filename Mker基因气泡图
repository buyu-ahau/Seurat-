ğŸ§¬ ç»†èƒç±»å‹æœ€ç»ˆæ’å
æ’å	ç»†èƒç±»å‹	ç»†èƒæ•°é‡	ç™¾åˆ†æ¯”
1	CD8_cells	9,450	26.75%
2	Plasma_cells	8,141	23.04%
3	Macrophages	6,054	17.14%
4	Neutrophils	3,425	9.69%
5	B_cells	2,226	6.30%
6	CD4_cells	1,838	5.20%
7	Fibroblasts	1,131	3.20%
8	Endothelial_cells	862	2.44%
9	NK_cells	747	2.11%
10	Epithelial_cells	624	1.77%
11	DC_cells	832	2.35%


# ==============================================================================
# å•ç»†èƒRNA-seqæ•°æ®é‡æ–°æ³¨é‡Šé¡¹ç›®
# ==============================================================================
# é¡¹ç›®åç§°: å•ç»†èƒæ•°æ®é‡æ–°æ³¨é‡Šå’Œä¿®æ­£
# æ—¥æœŸ: 2025-01-08
# ç”¨æˆ·: buyu-ahau
# ç›®çš„: ä¿®æ­£ç»†èƒç±»å‹æ³¨é‡Š (Cluster 19: Serous_cells -> Neutrophils)
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. é¡¹ç›®è®¾ç½®
# ------------------------------------------------------------------------------

# è®¾ç½®å·¥ä½œç›®å½•å’Œåˆ›å»ºé¡¹ç›®ç»“æ„
project_dir <- "/disk192/users_dir/buyu/2025-7-7é‡æ–°æ³¨é‡Šç»“æœ"
out_data    <- file.path(project_dir, "analysis_results")      # åˆ†æç»“æœç›®å½•
out_plot    <- file.path(project_dir, "plots")                # å›¾ç‰‡ç›®å½•
out_plot_final <- file.path(project_dir, "final_figures")     # æœ€ç»ˆå›¾ç‰‡ç›®å½•

# åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
dir.create(out_data, showWarnings = FALSE, recursive = TRUE)
dir.create(out_plot, showWarnings = FALSE, recursive = TRUE)
dir.create(out_plot_final, showWarnings = FALSE, recursive = TRUE)

# ------------------------------------------------------------------------------
# 2. åŠ è½½å¿…éœ€çš„RåŒ…
# ------------------------------------------------------------------------------

library(Seurat)     # å•ç»†èƒåˆ†æä¸»åŒ…
library(dplyr)      # æ•°æ®æ“ä½œ
library(ggplot2)    # ç»˜å›¾
library(patchwork)  # å›¾å½¢ç»„åˆ
library(qs)         # å¿«é€Ÿæ•°æ®å­˜å‚¨

# ------------------------------------------------------------------------------
# 3. æ•°æ®åŠ è½½å’ŒéªŒè¯
# ------------------------------------------------------------------------------

# æ£€æŸ¥å¯ç”¨çš„.qsæ–‡ä»¶
cat("æ£€æŸ¥å¯ç”¨æ–‡ä»¶:\n")
qs_files <- list.files(project_dir, pattern = "\\.qs$", full.names = TRUE)
for (file in qs_files) {
  cat("  â€¢", basename(file), "\n")
}

# æŒ‰ä¼˜å…ˆçº§é¡ºåºåŠ è½½æ•°æ®
file_priority <- c(
  file.path(project_dir, "object_final_annotated.qs"),         # æœ€ç»ˆæ³¨é‡Šç‰ˆæœ¬
  file.path(project_dir, "object_reannotated_final_celltype.qs"), # é‡æ–°æ³¨é‡Šç‰ˆæœ¬
  file.path(project_dir, "object_annotated_gene_symbols.qs")   # åŸºå› ç¬¦å·ç‰ˆæœ¬
)

seurat_obj <- NULL
loaded_file <- NULL

# å°è¯•åŠ è½½æ¯ä¸ªæ–‡ä»¶
for (file_path in file_priority) {
  if (file.exists(file_path)) {
    cat("å°è¯•åŠ è½½æ–‡ä»¶:", basename(file_path), "\n")
    tryCatch({
      seurat_obj <- qread(file_path)
      loaded_file <- file_path
      cat("æˆåŠŸ: å·²åŠ è½½", basename(file_path), "\n")
      break
    }, error = function(e) {
      cat("é”™è¯¯: åŠ è½½å¤±è´¥", basename(file_path), ":", e$message, "\n")
    })
  }
}

# æ£€æŸ¥æ˜¯å¦æˆåŠŸåŠ è½½æ•°æ®
if (is.null(seurat_obj)) {
  stop("é”™è¯¯: æ— æ³•åŠ è½½ä»»ä½•Seuratå¯¹è±¡")
}

# éªŒè¯åŠ è½½çš„æ•°æ®
cat("å·²ä»ä»¥ä¸‹æ–‡ä»¶åŠ è½½Seuratå¯¹è±¡:", basename(loaded_file), "\n")
print(seurat_obj)

# æ£€æŸ¥celltype_finalåˆ—æ˜¯å¦å­˜åœ¨
if (!"celltype_final" %in% colnames(seurat_obj@meta.data)) {
  stop("é”™è¯¯: åœ¨å…ƒæ•°æ®ä¸­æœªæ‰¾åˆ°celltype_finalåˆ—")
}

# è®¾ç½®ç»†èƒèº«ä»½
Idents(seurat_obj) <- "celltype_final"

# ------------------------------------------------------------------------------
# 4. æ•°æ®æ£€æŸ¥å’Œä¿®æ­£
# ------------------------------------------------------------------------------

# æ£€æŸ¥å½“å‰ç»†èƒç±»å‹åˆ†å¸ƒ
cat("å½“å‰ç»†èƒç±»å‹åˆ†å¸ƒ:\n")
current_table <- table(seurat_obj@meta.data$celltype_final)
print(current_table)

# åº”ç”¨ä¿®æ­£: Cluster 19 Serous_cells -> Neutrophils
cat("\nåº”ç”¨ä¿®æ­£: Cluster 19 Serous_cells -> Neutrophils\n")

# æŸ¥æ‰¾Serous_cellsï¼ˆåº”è¯¥æ˜¯Cluster 19ï¼‰
serous_cells_idx <- which(seurat_obj@meta.data$celltype_final == "Serous_cells")
cluster_19_idx <- which(seurat_obj@meta.data$seurat_clusters == 19)

cat("Serous_cells ç»†èƒæ•°:", length(serous_cells_idx), "\n")
cat("Cluster 19 ç»†èƒæ•°:", length(cluster_19_idx), "\n")

# éªŒè¯å®ƒä»¬æ˜¯å¦ç›¸åŒ
if (length(serous_cells_idx) == length(cluster_19_idx) && 
    all(serous_cells_idx == cluster_19_idx)) {
  cat("ç¡®è®¤: Serous_cellså¯¹åº”Cluster 19\n")
} else {
  cat("è­¦å‘Š: Serous_cellså’ŒCluster 19ä¸åŒ¹é…\n")
}

# æ‰§è¡Œä¿®æ­£
seurat_obj@meta.data$celltype_final[serous_cells_idx] <- "Neutrophils"
Idents(seurat_obj) <- "celltype_final"

# æ£€æŸ¥ä¿®æ­£åçš„åˆ†å¸ƒ
cat("\nä¿®æ­£åçš„ç»†èƒç±»å‹åˆ†å¸ƒ:\n")
corrected_table <- table(seurat_obj@meta.data$celltype_final)
print(corrected_table)

# è®¡ç®—ä¸­æ€§ç²’ç»†èƒç»„æˆ
neutrophil_cluster3 <- sum(seurat_obj@meta.data$seurat_clusters == 3)
neutrophil_cluster19 <- sum(seurat_obj@meta.data$seurat_clusters == 19)
total_neutrophils <- neutrophil_cluster3 + neutrophil_cluster19

cat("\nä¸­æ€§ç²’ç»†èƒç»„æˆè¯¦æƒ…:\n")
cat(sprintf("   - Cluster 3:  %d ä¸ªç»†èƒ (%.1f%%)\n", 
            neutrophil_cluster3, neutrophil_cluster3/total_neutrophils*100))
cat(sprintf("   - Cluster 19: %d ä¸ªç»†èƒ (%.1f%%) [å·²ä¿®æ­£]\n", 
            neutrophil_cluster19, neutrophil_cluster19/total_neutrophils*100))
cat(sprintf("   - æ€»è®¡:       %d ä¸ªç»†èƒ\n", total_neutrophils))

cat("\nä¿®æ­£å®Œæˆ! æ•°æ®ç°åœ¨åŒ…å«11ç§ç»†èƒç±»å‹ï¼ˆæ— Serous_cellsï¼‰\n")

# ------------------------------------------------------------------------------
# 5. ç‚¹å›¾å¯è§†åŒ–
# ------------------------------------------------------------------------------

# å®šä¹‰è¾…åŠ©å‡½æ•°
`%R%` <- function(x, n) { paste(rep(x, n), collapse = "") }

# åˆ›å»ºç´§å‡‘å‹ç‚¹å›¾å‡½æ•°
create_compact_dotplot_v2 <- function(seurat_obj, output_dir) {
  # è®¾ç½®é»˜è®¤åˆ†æå’Œèº«ä»½
  DefaultAssay(seurat_obj) <- "RNA"
  Idents(seurat_obj) <- "celltype_final"
  
  cat("\nåˆ›å»ºç‚¹å›¾ä¸­...\n")
  cat("å½“å‰ç»†èƒç±»å‹:", paste(sort(unique(Idents(seurat_obj))), collapse = ", "), "\n")
  
  # ä¼˜åŒ–çš„åŸºå› åˆ—è¡¨ï¼ˆå·²ç§»é™¤Serous_cellsç›¸å…³åŸºå› ï¼‰
  genes_by_celltype <- list(
    "CD4_cells" = c("CD40LG", "CD3D", "CD4", "IL7R"),           # CD4+ Tç»†èƒæ ‡è®°
    "CD8_cells" = c("CD8A", "CD8B", "CD3D", "GZMA"),           # CD8+ Tç»†èƒæ ‡è®°
    "NK_cells" = c("NKG7", "GNLY", "KLRB1", "NCR1"),           # NKç»†èƒæ ‡è®°
    "Neutrophils" = c("CXCL8", "CSF3R", "FCGR3B", "S100A8", "S100A9"), # ä¸­æ€§ç²’ç»†èƒæ ‡è®°
    "Macrophages" = c("CD163", "CD68", "C1QA", "APOE"),        # å·¨å™¬ç»†èƒæ ‡è®°
    "B_cells" = c("CD79B", "CD19", "MS4A1", "CD20"),           # Bç»†èƒæ ‡è®°
    "Plasma_cells" = c("JCHAIN", "CD79A", "IGHG1", "MZB1"),    # æµ†ç»†èƒæ ‡è®°
    "DC_cells" = c("HLA-DRA", "CD1C", "FCER1A", "CLEC9A"),     # æ ‘çªçŠ¶ç»†èƒæ ‡è®°
    "Epithelial_cells" = c("SFTPC", "SFTPA1", "EPCAM", "SCGB1A1", "FOXJ1", "KRT8"), # ä¸Šçš®ç»†èƒæ ‡è®°
    "Fibroblasts" = c("SPARCL1", "BGN", "MGP", "COL1A1", "COL3A1"),     # æˆçº¤ç»´ç»†èƒæ ‡è®°
    "Endothelial_cells" = c("CDH5", "PROX1", "CA4", "PECAM1", "VWF")    # å†…çš®ç»†èƒæ ‡è®°
  )
  
  # æ‰å¹³åŒ–åŸºå› åˆ—è¡¨å¹¶æ£€æŸ¥å¯ç”¨æ€§
  all_genes <- unlist(genes_by_celltype)
  names(all_genes) <- NULL
  available_genes <- intersect(all_genes, rownames(seurat_obj))
  
  cat("å¯ç”¨åŸºå› :", length(available_genes), "/", length(all_genes), "\n")
  
  # æ˜¾ç¤ºç¼ºå¤±çš„åŸºå› 
  missing_genes <- setdiff(all_genes, available_genes)
  if (length(missing_genes) > 0) {
    cat("ç¼ºå¤±åŸºå› :", paste(missing_genes, collapse = ", "), "\n")
  }
  
  # åˆ›å»ºè¶…ç´§å‡‘å‹ç‚¹å›¾
  p_compact <- DotPlot(
    object = seurat_obj,
    features = available_genes,
    assay = "RNA",
    scale = TRUE,      # æ ‡å‡†åŒ–è¡¨è¾¾é‡
    dot.scale = 6,     # ç‚¹çš„å¤§å°æ¯”ä¾‹
    col.min = -1,      # æœ€å°é¢œè‰²å€¼
    col.max = 2        # æœ€å¤§é¢œè‰²å€¼
  ) +
    # åº”ç”¨é»‘ç™½ä¸»é¢˜
    theme_bw() +
    theme(
      # Xè½´æ–‡æœ¬è®¾ç½®ï¼ˆç»†èƒç±»å‹ï¼‰
      axis.text.x = element_text(
        angle = 90,      # å‚ç›´æ—‹è½¬
        hjust = 1,       # æ°´å¹³å¯¹é½
        vjust = 0.5,     # å‚ç›´å¯¹é½
        size = 8,        # å­—ä½“å¤§å°
        color = "black"  # å­—ä½“é¢œè‰²
      ),
      # Yè½´æ–‡æœ¬è®¾ç½®ï¼ˆåŸºå› åï¼‰
      axis.text.y = element_text(
        size = 8,        # å­—ä½“å¤§å°
        color = "black", # å­—ä½“é¢œè‰²
        face = "italic"  # æ–œä½“
      ),
      # Xè½´æ ‡é¢˜è®¾ç½®
      axis.title.x = element_text(
        size = 10,       # å­—ä½“å¤§å°
        face = "bold",   # ç²—ä½“
        margin = margin(t = 5)  # ä¸Šè¾¹è·
      ),
      # Yè½´æ ‡é¢˜è®¾ç½®
      axis.title.y = element_text(
        size = 10,       # å­—ä½“å¤§å°
        face = "bold",   # ç²—ä½“
        margin = margin(r = 5)  # å³è¾¹è·
      ),
      # å›¾ä¾‹è®¾ç½®
      legend.position = "bottom",        # å›¾ä¾‹ä½ç½®
      legend.box = "horizontal",         # æ°´å¹³æ’åˆ—
      legend.margin = margin(t = 5),     # å›¾ä¾‹è¾¹è·
      legend.title = element_text(size = 9, face = "bold"),  # å›¾ä¾‹æ ‡é¢˜
      legend.text = element_text(size = 8),                  # å›¾ä¾‹æ–‡æœ¬
      legend.key.size = unit(0.4, "cm"),                     # å›¾ä¾‹é”®å¤§å°
      # ç§»é™¤ç½‘æ ¼çº¿
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      # èƒŒæ™¯è®¾ç½®
      panel.background = element_rect(fill = "white", color = NA),
      panel.border = element_rect(color = "black", linewidth = 0.5, fill = NA),
      # æ ‡é¢˜è®¾ç½®
      plot.title = element_text(
        hjust = 0.5,     # å±…ä¸­
        size = 12,       # å­—ä½“å¤§å°
        face = "bold",   # ç²—ä½“
        margin = margin(b = 8)  # ä¸‹è¾¹è·
      ),
      # æ•´ä½“è¾¹è·
      plot.margin = margin(10, 10, 10, 10),
      # åˆ»åº¦çº¿é•¿åº¦
      axis.ticks.length = unit(0.1, "cm")
    ) +
    # é¢œè‰²æ¸å˜è®¾ç½®
    scale_color_gradient2(
      low = "blue",      # ä½è¡¨è¾¾é¢œè‰²
      mid = "white",     # ä¸­ç­‰è¡¨è¾¾é¢œè‰²
      high = "red",      # é«˜è¡¨è¾¾é¢œè‰²
      midpoint = 0,      # ä¸­ç‚¹å€¼
      name = "å¹³å‡è¡¨è¾¾é‡",
      guide = guide_colorbar(
        title.position = "top",    # æ ‡é¢˜ä½ç½®
        title.hjust = 0.5,         # æ ‡é¢˜å±…ä¸­
        barwidth = 6,              # é¢œè‰²æ¡å®½åº¦
        barheight = 0.6            # é¢œè‰²æ¡é«˜åº¦
      )
    ) +
    # ç‚¹å¤§å°å›¾ä¾‹è®¾ç½®
    guides(
      size = guide_legend(
        title = "è¡¨è¾¾ç™¾åˆ†æ¯”",
        title.position = "top",
        title.hjust = 0.5,
        override.aes = list(color = "black"),
        nrow = 1,
        keywidth = unit(0.4, "cm"),
        keyheight = unit(0.4, "cm")
      )
    ) +
    # åæ ‡è½´æ ‡ç­¾
    labs(
      title = "ç»†èƒç±»å‹æ ‡è®°åŸºå› è¡¨è¾¾æ¨¡å¼ (ä¿®æ­£ç‰ˆ v2)",
      x = "ç»†èƒç±»å‹",
      y = "æ ‡è®°åŸºå› "
    )
  
  # ä¿å­˜å›¾ç‰‡æ–‡ä»¶
  # PDFæ ¼å¼ï¼ˆçŸ¢é‡å›¾ï¼Œé€‚åˆå‘è¡¨ï¼‰
  ggsave(
    filename = file.path(output_dir, "ultra_compact_dotplot_corrected.pdf"),
    plot = p_compact,
    device = "pdf",
    width = 10,        # å®½åº¦ï¼ˆè‹±å¯¸ï¼‰
    height = 6,        # é«˜åº¦ï¼ˆè‹±å¯¸ï¼‰
    useDingbats = FALSE
  )
  
  # PNGæ ¼å¼ï¼ˆä½å›¾ï¼Œé€‚åˆå±•ç¤ºï¼‰
  ggsave(
    filename = file.path(output_dir, "ultra_compact_dotplot_corrected.png"),
    plot = p_compact,
    device = "png",
    width = 10,
    height = 6,
    dpi = 300,         # åˆ†è¾¨ç‡
    bg = "white"       # èƒŒæ™¯é¢œè‰²
  )
  
  # TIFFæ ¼å¼ï¼ˆé«˜è´¨é‡ä½å›¾ï¼Œé€‚åˆå‘è¡¨ï¼‰
  ggsave(
    filename = file.path(output_dir, "ultra_compact_dotplot_corrected.tiff"),
    plot = p_compact,
    device = "tiff",
    width = 10,
    height = 6,
    dpi = 300,
    bg = "white"
  )
  
  cat("ç‚¹å›¾å·²ä¿å­˜åˆ°:", output_dir, "\n")
  return(p_compact)
}

# è¿è¡Œç‚¹å›¾åˆ›å»º
cat("\n", paste(rep("=", 50), collapse = ""), "\n")
cat("åˆ›å»ºä¿®æ­£ç‰ˆç‚¹å›¾ä¸­...\n")
cat("æ—¶é—´:", Sys.time(), "\n")
cat("ç”¨æˆ·: buyu-ahau\n")
cat(paste(rep("=", 50), collapse = ""), "\n")

# æ‰§è¡Œç‚¹å›¾åˆ›å»ºå‡½æ•°
ultra_compact_plot_corrected <- create_compact_dotplot_v2(seurat_obj, out_plot_final)

# ------------------------------------------------------------------------------
# 6. ä¿å­˜ç»“æœ
# ------------------------------------------------------------------------------

# ä¿å­˜ä¿®æ­£åçš„Seuratå¯¹è±¡
cat("\nä¿å­˜ä¿®æ­£åçš„Seuratå¯¹è±¡...\n")
corrected_file <- file.path(project_dir, "object_final_annotated_corrected_v2.qs")
qsave(seurat_obj, corrected_file)
cat("æˆåŠŸ: ä¿®æ­£åçš„Seuratå¯¹è±¡å·²ä¿å­˜ä¸º:", basename(corrected_file), "\n")

# ä¿å­˜ç»†èƒç±»å‹ç»Ÿè®¡è¡¨
cat("\nä¿å­˜ç»†èƒç±»å‹ç»Ÿè®¡è¡¨...\n")
corrected_stats <- data.frame(
  Cell_Type = names(corrected_table),                                    # ç»†èƒç±»å‹åç§°
  Cell_Count = as.integer(corrected_table),                              # ç»†èƒæ•°é‡
  Percentage = round(as.numeric(corrected_table)/sum(corrected_table)*100, 2), # ç™¾åˆ†æ¯”
  stringsAsFactors = FALSE
)
# æŒ‰ç»†èƒæ•°é‡é™åºæ’åˆ—
corrected_stats <- corrected_stats[order(corrected_stats$Cell_Count, decreasing = TRUE), ]
corrected_stats$Rank <- 1:nrow(corrected_stats)  # æ·»åŠ æ’å
corrected_stats <- corrected_stats[, c("Rank", "Cell_Type", "Cell_Count", "Percentage")]

# ä¿å­˜ä¸ºCSVæ–‡ä»¶
write.csv(corrected_stats, 
          file = file.path(project_dir, "celltype_statistics_corrected_v2.csv"), 
          row.names = FALSE)
cat("æˆåŠŸ: ç»Ÿè®¡è¡¨å·²ä¿å­˜ä¸º: celltype_statistics_corrected_v2.csv\n")

# ä¿å­˜é›†ç¾¤æ˜ å°„è¡¨
cat("\nä¿å­˜é›†ç¾¤æ˜ å°„è¡¨...\n")
# ä¿®æ­£åçš„é›†ç¾¤åˆ°ç»†èƒç±»å‹æ˜ å°„
final_map_corrected <- c(
  "0" = "CD8_cells", "1" = "Plasma_cells", "2" = "Plasma_cells",
  "3" = "Neutrophils", "4" = "Macrophages", "5" = "Macrophages",
  "6" = "CD8_cells", "7" = "B_cells", "8" = "CD4_cells",
  "9" = "Fibroblasts", "10" = "DC_cells", "11" = "NK_cells",
  "12" = "Endothelial_cells", "13" = "Epithelial_cells",
  "14" = "Endothelial_cells", "15" = "B_cells", "16" = "Epithelial_cells",
  "17" = "NK_cells", "18" = "Fibroblasts", "19" = "Neutrophils"  # å…³é”®ä¿®æ­£
)

# åˆ›å»ºæ˜ å°„æ•°æ®æ¡†
cluster_mapping_df <- data.frame(
  Cluster = names(final_map_corrected),                                   # é›†ç¾¤ç¼–å·
  Cell_Type = as.character(final_map_corrected),                         # ç»†èƒç±»å‹
  Cell_Count = as.integer(table(seurat_obj@meta.data$seurat_clusters)[names(final_map_corrected)]), # ç»†èƒæ•°é‡
  Status = ifelse(names(final_map_corrected) == "19", "å·²ä¿®æ­£", "åŸå§‹"), # çŠ¶æ€æ ‡è®°
  stringsAsFactors = FALSE
)

# ä¿å­˜æ˜ å°„è¡¨
write.csv(cluster_mapping_df, 
          file = file.path(project_dir, "cluster_to_celltype_mapping_corrected_v2.csv"), 
          row.names = FALSE)
cat("æˆåŠŸ: é›†ç¾¤æ˜ å°„è¡¨å·²ä¿å­˜ä¸º: cluster_to_celltype_mapping_corrected_v2.csv\n")

# ç”Ÿæˆä¿®æ­£æŠ¥å‘Š
cat("\nç”Ÿæˆä¿®æ­£æŠ¥å‘Š...\n")
report_file <- file.path(project_dir, "correction_report_v2.txt")
report_content <- paste(
  "=======================================================",
  "å•ç»†èƒæ•°æ®é‡æ–°æ³¨é‡Šä¿®æ­£æŠ¥å‘Š",
  "=======================================================",
  "",
  paste("æ—¥æœŸ:", Sys.time()),
  paste("ç”¨æˆ·: buyu-ahau"),
  paste("åŸå§‹æ–‡ä»¶: object_final_annotated.qs"),
  paste("ä¿®æ­£æ–‡ä»¶: object_final_annotated_corrected_v2.qs"),
  "",
  "åº”ç”¨çš„ä¿®æ­£:",
  "- Cluster 19: Serous_cells -> Neutrophils",
  "- 66ä¸ªç»†èƒä»Serous_cellsé‡æ–°åˆ†ç±»ä¸ºNeutrophils",
  "",
  "æœ€ç»ˆç»“æœ:",
  paste("- æ€»ç»†èƒæ•°:", format(ncol(seurat_obj), big.mark = ",")),
  paste("- æ€»åŸºå› æ•°:", format(nrow(seurat_obj), big.mark = ",")),
  paste("- ç»†èƒç±»å‹æ•°: 11 (ç§»é™¤äº†Serous_cells)"),
  "",
  "ä¸­æ€§ç²’ç»†èƒç»„æˆ:",
  paste("- Cluster 3:", neutrophil_cluster3, "ä¸ªç»†èƒ (98.1%)"),
  paste("- Cluster 19:", neutrophil_cluster19, "ä¸ªç»†èƒ (1.9%) [å·²ä¿®æ­£]"),
  paste("- æ€»è®¡:", total_neutrophils, "ä¸ªç»†èƒ"),
  "",
  "ç”Ÿæˆçš„æ–‡ä»¶:",
  "- object_final_annotated_corrected_v2.qs",
  "- celltype_statistics_corrected_v2.csv",
  "- cluster_to_celltype_mapping_corrected_v2.csv",
  "- ultra_compact_dotplot_corrected.pdf/png/tiff",
  "- correction_report_v2.txt",
  "",
  "=======================================================",
  "ä¿®æ­£æˆåŠŸå®Œæˆ!",
  "=======================================================",
  sep = "\n"
)

# å†™å…¥æŠ¥å‘Šæ–‡ä»¶
writeLines(report_content, report_file)
cat("æˆåŠŸ: ä¿®æ­£æŠ¥å‘Šå·²ä¿å­˜ä¸º:", basename(report_file), "\n")

# ------------------------------------------------------------------------------
# 7. æœ€ç»ˆç¡®è®¤
# ------------------------------------------------------------------------------

cat("\n", paste(rep("=", 60), collapse = ""), "\n")
cat("æœ€ç»ˆç¡®è®¤ - ä¿®æ­£å·²æˆåŠŸä¿å­˜\n")
cat(paste(rep("=", 60), collapse = ""), "\n")
cat("æ—¥æœŸ:", Sys.time(), "\n")
cat("ç”¨æˆ·: buyu-ahau\n")
cat("çŠ¶æ€: å·²å®Œæˆ\n")
cat("\nç”Ÿæˆçš„æ–‡ä»¶:\n")
cat("1. object_final_annotated_corrected_v2.qs - ä¿®æ­£åçš„Seuratå¯¹è±¡\n")
cat("2. celltype_statistics_corrected_v2.csv - ç»†èƒç±»å‹ç»Ÿè®¡è¡¨\n")
cat("3. cluster_to_celltype_mapping_corrected_v2.csv - é›†ç¾¤æ˜ å°„è¡¨\n")
cat("4. ultra_compact_dotplot_corrected.pdf/png/tiff - ç‚¹å›¾å¯è§†åŒ–æ–‡ä»¶\n")
cat("5. correction_report_v2.txt - è¯¦ç»†ä¿®æ­£æŠ¥å‘Š\n")
cat(paste(rep("=", 60), collapse = ""), "\n")

# ==============================================================================
# è„šæœ¬ç»“æŸ
# ==============================================================================

# å¯é€‰: æ˜¾ç¤ºæœ€ç»ˆçš„ç»†èƒç±»å‹åˆ†å¸ƒ
cat("\næœ€ç»ˆç»†èƒç±»å‹åˆ†å¸ƒæ€»ç»“:\n")
final_summary <- data.frame(
  æ’å = 1:nrow(corrected_stats),
  ç»†èƒç±»å‹ = corrected_stats$Cell_Type,
  ç»†èƒæ•°é‡ = corrected_stats$Cell_Count,
  ç™¾åˆ†æ¯” = paste0(corrected_stats$Percentage, "%")
)
print(final_summary)

cat("\nğŸ‰ é¡¹ç›®å®Œæˆ! æ‰€æœ‰æ–‡ä»¶å·²ä¿å­˜åˆ°:", project_dir, "\n")

