🧬 细胞类型最终排名
排名	细胞类型	细胞数量	百分比
1	CD8_cells	9,450	26.75%
2	Plasma_cells	8,141	23.04%
3	Macrophages	6,054	17.14%
4	Neutrophils	3,425	9.69%
5	B_cells	2,226	6.30%
6	CD4_cells	1,838	5.20%
7	Fibroblasts	1,131	3.20%
8	Endothelial_cells	862	2.44%
9	NK_cells	747	2.11%
10	Epithelial_cells	624	1.77%
11	DC_cells	832	2.35%


# ==============================================================================
# 2.2 Modified Enhanced DotPlot with Border and Vertical Text
# ==============================================================================

cat("Generating modified DotPlot with border and vertical text...\n")

# Create modified enhanced DotPlot
p_dot_modified <- DotPlot(
  seurat_obj,
  features = available_genes,
  scale = TRUE,
  dot.scale = 8,
  col.min = -2,
  col.max = 2
) +
  theme_bw() +  # Use theme_bw for border
  theme(
    # X-axis text (cell types) - vertical
    axis.text.x = element_text(
      angle = 90,           # Vertical text
      hjust = 1,            # Right alignment
      vjust = 0.5,          # Center vertically
      size = 11,            # Font size
      face = "bold"         # Bold font
    ),
    # Y-axis text (genes) - italic
    axis.text.y = element_text(
      size = 10, 
      face = "italic"
    ),
    # Axis titles
    axis.title = element_text(
      size = 12, 
      face = "bold"
    ),
    # Legend position and style
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.title = element_text(
      size = 10, 
      face = "bold"
    ),
    legend.text = element_text(size = 8),
    # Plot title
    plot.title = element_text(
      hjust = 0.5, 
      size = 14, 
      face = "bold"
    ),
    # Panel styling with border
    panel.border = element_rect(
      color = "black", 
      fill = NA, 
      size = 1
    ),
    panel.grid.major = element_line(
      color = "grey90", 
      size = 0.5
    ),
    panel.grid.minor = element_blank(),
    # Plot margins
    plot.margin = margin(15, 15, 15, 15)
  ) +
  scale_color_gradient2(
    low = "blue", 
    mid = "white", 
    high = "red",
    name = "Average\nExpression"
  ) +
  guides(
    color = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = 8,
      barheight = 0.8
    ),
    size = guide_legend(
      title = "Percent\nExpressed",
      title.position = "top",
      title.hjust = 0.5,
      override.aes = list(color = "black")
    )
  ) +
  labs(
    title = "Cell Type Marker Gene Expression Pattern (Corrected)",
    x = "Cell Types",
    y = "Marker Genes"
  )

# Save modified DotPlot
ggsave(
  filename = file.path(new_viz_dir, "enhanced_dotplot_bordered.pdf"),
  plot = p_dot_modified,
  width = 16, height = 9,
  useDingbats = FALSE
)

ggsave(
  filename = file.path(new_viz_dir, "enhanced_dotplot_bordered.png"),
  plot = p_dot_modified,
  width = 16, height = 9,
  dpi = 300, bg = "white"
)

ggsave(
  filename = file.path(new_viz_dir, "enhanced_dotplot_bordered.tiff"),
  plot = p_dot_modified,
  width = 16, height = 9,
  dpi = 300, bg = "white"
)

cat("Modified DotPlot with border and vertical text saved successfully!\n")
cat("Files generated:\n")
cat("- enhanced_dotplot_bordered.pdf\n")
cat("- enhanced_dotplot_bordered.png\n")
cat("- enhanced_dotplot_bordered.tiff\n")
cat(paste(rep("=", 60), collapse = ""), "\n")

# Display the modified plot
print(p_dot_modified)

